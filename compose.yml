name: hourly

services:
  postgres:
    image: postgres:18.1-alpine3.23
    networks:
      - postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres:/var/lib/postgresql/data:rw
    shm_size: 128mb
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          memory: 256M
    labels:
      - "com.hourly.service=postgres"
      - "com.hourly.managed-by=docker-compose"
    restart: unless-stopped

  opensearch:
    image: opensearchproject/opensearch:2.19.4
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      memlock:
        soft: -1
        hard: -1
    networks:
      - opensearch
    ports:
      - 9200:9200
      - 9600:9600
    environment:
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=${OPENSEARCH_ADMIN_PASSWORD}
      - OPENSEARCH_JAVA_OPTS=-Xms256m -Xmx256m
      - DISABLE_INSTALL_DEMO_CONFIG=true
      - discovery.type=single-node
      - plugins.security.disabled=true
      - cluster.routing.allocation.disk.threshold_enabled=true
      - cluster.routing.allocation.disk.watermark.low=512mb
      - cluster.routing.allocation.disk.watermark.high=256mb
      - cluster.routing.allocation.disk.watermark.flood_stage=128mb
    volumes:
      - opensearch:/usr/share/opensearch/data:rw
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 60s
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          memory: 256M
    labels:
      - "com.hourly.service=opensearch"
      - "com.hourly.managed-by=docker-compose"
    restart: unless-stopped

  opensearch-dashboard:
    image: opensearchproject/opensearch-dashboards:2.19.4
    depends_on:
      opensearch:
        condition: service_healthy
    networks:
      - opensearch
    ports:
      - 5601:5601
    environment:
      - OPENSEARCH_HOSTS=["http://opensearch:9200"]
      - OPENSEARCH_PASSWORD=${OPENSEARCH_ADMIN_PASSWORD}
      - DISABLE_SECURITY_DASHBOARDS_PLUGIN=true
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5601/api/status || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 30s
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M
        reservations:
          memory: 128M
    labels:
      - "com.hourly.service=opensearch-dashboard"
      - "com.hourly.managed-by=docker-compose"
    restart: unless-stopped

  temporal:
    image: temporalio/auto-setup:1.29.2
    depends_on:
      postgres:
        condition: service_healthy
      opensearch:
        condition: service_healthy
    networks:
      postgres:
      opensearch:
      temporal:
        ipv4_address: 172.100.0.2
    ports:
      - 7233:7233
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PWD=${POSTGRES_PASSWORD}
      - POSTGRES_SEEDS=postgres
      - DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig/development-sql.yaml
      - TEMPORAL_ADDRESS=temporal:7233
      - BIND_ON_IP=0.0.0.0
      - TEMPORAL_BROADCAST_ADDRESS=172.100.0.2
      - ENABLE_ES=true
      - ES_SEEDS=opensearch
      - ES_PWD=${OPENSEARCH_ADMIN_PASSWORD}
    volumes:
      - ./packages/temporal/dynamicconfig:/etc/temporal/config/dynamicconfig
    healthcheck:
      test: ["CMD-SHELL", "tctl --address temporal:7233 --namespace default namespace list"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 60s
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 384M
        reservations:
          memory: 192M
    labels:
      - "kompose.volume.type=configMap"
      - "com.hourly.service=temporal"
      - "com.hourly.managed-by=docker-compose"
    restart: unless-stopped

  temporal-admin-tools:
    image: temporalio/admin-tools:1.29.1-tctl-1.18.4-cli-1.5.0
    depends_on:
      temporal:
        condition: service_healthy
    networks:
      - temporal
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CLI_ADDRESS=temporal:7233
    stdin_open: true
    tty: true
    healthcheck:
      test: ["CMD-SHELL", "tctl --address temporal:7233 --namespace default namespace list"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 30s
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: "0.1"
          memory: 128M
        reservations:
          memory: 64M
    labels:
      - "com.hourly.service=temporal-admin-tools"
      - "com.hourly.managed-by=docker-compose"
    restart: unless-stopped

  temporal-ui:
    image: temporalio/ui:2.44.0
    depends_on:
      temporal:
        condition: service_healthy
    networks:
      - temporal
    ports:
      - 9002:8080
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CORS_ORIGINS=http://localhost:9002
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/readyz || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 20s
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: "0.1"
          memory: 128M
        reservations:
          memory: 64M
    labels:
      - "com.hourly.service=temporal-ui"
      - "com.hourly.managed-by=docker-compose"
    restart: unless-stopped

networks:
  postgres:
  opensearch:

  temporal:
    ipam:
      config:
        - subnet: 172.100.0.0/24
          gateway: 172.100.0.1

volumes:
  postgres:
  opensearch:
